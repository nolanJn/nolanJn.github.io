---
layout:     post
title:      Dubbo & Dubbox
subtitle:   分布式RPC框架dubbo详解
date:       2017-08-10
author:     Nolan
header-img: img/post-bg-ios10.jpg
catalog: true
tags:
    - dubbo
    - dubbox
---

## 一、初识Dubbo ##

**背景** ：随着互联网的发展，应用服务的规模不断扩大，常规的垂直服务架构已经无法应对，分布式服务架构以及流动计算架构势在必行，急需一个治理系统取保架构有条不紊的演进。

**认识**：Dubbo是阿里巴巴提供的开源的一个分布式服务框架，致力于提供高性能和透明化的RPC远程服务调用方案，以及SOA服务治理方案。

## 二、Dubbo工作原理-主体架构 ##

![dubbo架构设计](/img/dubbo_job_lc.jpg)
### Dubbo工作原理-核心部分 ###
**远程通讯**：提供对多种基于长连接的NIO框架抽象封装，包含多种线程
模型，序列化，以及“请求-响应”模式的信息交换方式。

**集群容错**：提供基于接口方法的透明远程过程调用，包括多协议支持，
以及软负载均衡，失败容错，地址路由，动态配置等集群支持。

**自动发现**：基于注册中心目录服务，试服务消费方能动态的查找服务提
供方，使地址透明，使服务提供方可以平滑增加或减少机器。

### Dubbo功能特性-RPC功能 ###
![dubbo RPC功能](/img/dubbo_rpc.jpg)
### Dubbo功能特性-健壮性 ###
1、监控中心宕掉不影响使用，只是丢失部分采样数据

2、数据库宕掉后，注册中心仍能通过缓存提供服务列表查询，但不能注册新服务

3、注册中心对等集群，任意一台宕掉后，将自动切换到另一台

4、注册中心全部宕掉后，服务提供者和服务消费者仍能通过本地缓存通讯

5、服务提供者无状态，任意一台宕掉后，不影响使用

6、服务提供者全部宕掉后，服务消费者应用将无法使用，并无限次重连等待服务提供者恢复

### Dubbo功能特性-伸缩性 ###
注册中心为对等集群，可动态增加机器部署实例，所有客户端将自动发现新的注册中心

服务提供者无状态，可动态增加机器部署实例，注册中心将推送新的服务提供者信息给消费者

## 三、Dubbo快速入门案例 ##

### 快速启动 ###
Dubbo采用全Spring配置方式，透明化接入应用，对应用没有任何API侵入，只需用Spring加载Dubbo的配置即可，Dubbo基于Spring的Schema扩展进行加载。

如果不想使用Spring配置，而希望通过API的方式进行调用（不推荐）

### 服务提供者-定义服务接口 ###

(注：该接口需单独打包，在服务提供方和消费方共享)
![定义接口](/img/dubbo_dyjk.jpg)
### 服务提供者-实现接口 ###
(注：对服务消费方隐藏实现)
![接口实现](/img/dubbo_jksx.jpg)
### 服务提供者-Spring配置声明暴露服务 ###
![暴露服务](/img/dubbo_plfw.jpg)
### 服务提供者-加载配置 ###
![启动服务](/img/dubbo_qdfw.jpg)
### 服务消费者-通过spring配置引用远程服务 ###
![消费服务](/img/dubbo_xffw.jpg)

## 四、服务治理 ##

![服务治理](/img/dubbo_fwzl.png)

###各节点关系###

这里的Invoker是Provider的一个可调用Service的抽象，Invoker封装了Provider地址及Service接口信息。

Directory代表多个Invoker，可以把它看成List<Invoker>，但与List不同的是，它的值可能是动态变化的，比如注册中心推送变更。

Cluster将Directory中的多个Invoker伪装成一个Invoker，对上层透明，伪装过程包含了容错逻辑，调用失败后，重试另一个。

Router负责从多个Invoker中按路由规则选出子集，比如读写分离，应用隔离等。

LoadBalance负责从多个Invoker中选出具体的一个用于本次调用，选的过程包含了负载均衡算法，调用失败后，需要重选。

###集群容错模式###

**Failover Cluster**
失败自动切换，当出现失败，重试其它服务器。(缺省)
通常用于读操作，但重试会带来更长延迟。
可通过retries="2"来设置重试次数(不含第一次)。

**Failfast Cluster**
快速失败，只发起一次调用，失败立即报错。
通常用于非幂等性的写操作，比如新增记录。

**Failsafe Cluster**
失败安全，出现异常时，直接忽略。
通常用于写入审计日志等操作。

**Failback Cluster**
失败自动恢复，后台记录失败请求，定时重发。
通常用于消息通知操作。

**Forking Cluster**
并行调用多个服务器，只要一个成功即返回。
通常用于实时性要求较高的读操作，但需要浪费更多服务资源。
可通过forks="2"来设置最大并行数。

**Broadcast Cluster**
广播调用所有提供者，逐个调用，任意一台报错则报错。(2.1.0开始支持)
通常用于通知所有提供者更新缓存或日志等本地资源信息。

